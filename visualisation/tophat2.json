{"edges":[{"to":"tophat2:__REFERENCE_GENOME__","from":"reference_genome","id":"ref_to_tophat2"},{"to":"tophat2:__TRANSCRIPTOME_INDEX__","from":"transcriptome","id":"transcriptome_to_tophat2"},{"to":"bamcollate2","from":"src_bam","id":"src_to_bc2"},{"to":"tee_input","from":"bamcollate2","id":"bc2_to_ti"},{"to":"bamrecompress_input","from":"tee_input","id":"ti_to_brc"},{"to":"int_adp_bam","from":"bamrecompress_input","id":"brc_to_int_adp_bam"},{"to":"bamcollate2_ranking","from":"tee_input:__FIFO__","id":"ti_to_bamcollate2_ranking"},{"to":"bamreset_tophat","from":"bamcollate2_ranking","id":"bamcollate2_ranking_to_bamreset_tophat"},{"to":"bamadapterclip","from":"bamreset_tophat","id":"bamreset_tophat_to_bamtofastq"},{"to":"bamtofastq","from":"bamadapterclip","id":"bamadapterclip_to_bamtofastq"},{"to":"fq1","from":"bamtofastq:__FQOUT1__","id":"bamtofastq_to_fq1"},{"to":"fq2","from":"bamtofastq:__FQOUT2__","id":"bamtofastq_to_fq2"},{"to":"tophat2:__FQIN1__","from":"fq1","id":"fq1_to_tophat2"},{"to":"tophat2:__FQIN2__","from":"fq2","id":"fq2_to_tophat2"},{"to":"accepted_hits_bam","from":"tophat2","id":"tophat2_to_accepted_hits_bam"},{"to":"unmapped_bam","from":"tophat2","id":"tophat2_to_unmapped_bam"},{"to":"bamcat:__IN_BAM1__","from":"accepted_hits_bam","id":"accepted_hits_bam_to_bamcat"},{"to":"bamcat:__IN_BAM2__","from":"unmapped_bam","id":"unmapped_bam_to_bamcat"},{"to":"tee_headerSQfix","from":"bamcat","id":"bamcat_to_tee_headerSQfix"},{"to":"sam_headerSQfix","from":"tee_headerSQfix:__OUT1__","id":"tee_headerSQfix_to_sam"},{"to":"alterSQ_headerSQfix:__IN_DICT__","from":"reference_dict","id":"reference_dict_to_sam_headerSQfix"},{"to":"alterSQ_headerSQfix","from":"sam_headerSQfix","id":"sam_headerSQfix_to_alterSQ"},{"to":"reheader_headerSQfix:__IN_SAMHEADER__","from":"alterSQ_headerSQfix","id":"alterSQ_headerSQfix_to_reheader"},{"to":"mbuffer_headerSQfix","from":"tee_headerSQfix","id":"tee_headerSQfix_to_mbuffer"},{"to":"reheader_headerSQfix:__IN_BAM__","from":"mbuffer_headerSQfix","id":"mbuffer_headerSQfix_to_reheader"},{"to":"bam12split_tophat","from":"reheader_headerSQfix","id":"reheader_headerSQfix_to_bam12split_tophat"},{"to":"bamsort_qname","from":"bam12split_tophat","id":"bam12split_tophat_to_bamsort_qname"},{"to":"bamreset_prealn","from":"int_adp_bam","id":"bam_to_bamreset_prealn"},{"to":"bamadapterclip_prealn","from":"bamreset_prealn","id":"bamreset_prealn_to_bamadapterclip_prealn"},{"to":"bam12auxmerge:__PREALN_BAM__","from":"bamadapterclip_prealn","id":"bamadapterclip_prealn_to_bam12auxmerge"},{"to":"bam12auxmerge","from":"bamsort_qname","id":"bsqn_to_bam12auxmerge"},{"to":"alignment_filter:__TARGET_INBAM__","from":"bam12auxmerge","id":"bam12auxmerge_to_alignment_filter"},{"to":"alignment_filter:__PHIX_INBAM__","from":"int_adp_bam","id":"iab_to_alignment_filter"},{"to":"af_metrics","from":"alignment_filter:__AF_METRICS__","id":"alignment_filter_to_metrics"},{"to":"bamsort_coord_phix","from":"alignment_filter:__PHIX_OUTBAM__","id":"alignmentfilter_to_bamsort_coord_phix"},{"to":"bammarkduplicates_phix","from":"bamsort_coord_phix","id":"bamsort_phix_to_bammarkduplicates_phix"},{"to":"bamrecompress_phix","from":"bammarkduplicates_phix","id":"bammarkduplicates_phix_to_bamrecompress_phix"},{"to":"phix_bam","from":"bamrecompress_phix","id":"bamrecompress_to_pb"},{"to":"bamsort_coord_target","from":"alignment_filter","id":"alignmentfilter_to_bamsort_coord_target"},{"to":"bammarkduplicates_target","from":"bamsort_coord_target","id":"bamsort_phix_to_bammarkduplicates_target"},{"to":"bamrecompress_target","from":"bammarkduplicates_target","id":"bmd_to_bamrecompress"},{"to":"target_bam","from":"bamrecompress_target","id":"final_stretch"},{"to":"bamcat_output:__PHIXBAM__","from":"phix_bam","id":"phix_bam_to_bamcat"},{"to":"bamcat_output:__TARGETBAM__","from":"target_bam","id":"target_bam_to_bamcat"},{"to":"seqchksum_output","from":"bamcat_output","id":"bamcat_to_chk_output"},{"to":"seqchksum_input","from":"src_bam","id":"src_bam_to_chk_input"},{"to":"cmp_seqchksum:__OUTPUTCHK__","from":"seqchksum_output","id":"seqchksum_output_to_cmp"},{"to":"cmp_seqchksum:__INPUTCHK__","from":"seqchksum_input","id":"seqchksum_input_to_cmp"}],"nodes":[{"name":"/nfs/srpipe_references/references/Homo_sapiens/1000Genomes_hs37d5/all/bowtie2/hs37d5.fa","type":"INFILE","id":"reference_genome","description":"Prefix for reference fasta and Bowtie2 index files"},{"name":"/nfs/srpipe_references/references/Homo_sapiens/1000Genomes_hs37d5/all/picard/hs37d5.fa.dict","type":"INFILE","id":"reference_dict","description":"Extra metadata e.g. UR, M5 auxtags for BAM SQ header records"},{"name":"/nfs/srpipe_references/transcriptomes/Homo_sapiens/ensembl_75_transcriptome/1000Genomes_hs37d5/tophat2/1000Genomes_hs37d5.known","type":"INFILE","id":"transcriptome","description":"Prefix for transcripome files - gtf file and Tophat2 generated indexes for reference"},{"name":"input.bam","type":"INFILE","id":"src_bam","description":"BAM using as input to this pipeline - expected to already contain PhiX (normally from hyb buffer spike-in) alignments"},{"comment":"ensure BAM records are gathered by template i.e. queryname","cmd":["bamcollate2","collate=1","level=0"],"type":"EXEC","id":"bamcollate2"},{"cmd":"tee __FIFO__","type":"EXEC","id":"tee_input"},{"cmd":"bamrecompress verbose=0 numthreads=2","type":"EXEC","id":"bamrecompress_input"},{"name":"int_adp.bam","type":"RAFILE","id":"int_adp_bam"},{"comment":"already collated suitably - just here to do the ranking in the name","cmd":"bamcollate2 collate=3 level=0","type":"EXEC","id":"bamcollate2_ranking"},{"comment":"Alignment removal also required for bamadapterclip (at least 0.0.142)","cmd":"bamreset resetaux=0 level=0 verbose=0","type":"EXEC","id":"bamreset_tophat"},{"cmd":"bamadapterclip verbose=0 level=0","type":"EXEC","id":"bamadapterclip","description":"Hard clip adapter sequence from reads before feeding to Tophat2"},{"cmd":["bamtofastq","gz=1","F=__FQOUT1__","F2=__FQOUT2__"],"type":"EXEC","id":"bamtofastq"},{"name":"intfile_1.fq.gz","type":"RAFILE","id":"fq1"},{"name":"intfile_2.fq.gz","type":"RAFILE","id":"fq2"},{"cmd":"tophat2 --no-sort-bam --output-dir tophat_out --mate-inner-dist 100 --num-threads 12 --library-type fr-unstranded --no-coverage-search --microexon-search --transcriptome-index __TRANSCRIPTOME_INDEX__ __REFERENCE_GENOME__ __FQIN1__ __FQIN2__","type":"EXEC","id":"tophat2"},{"subtype":"DUMMY","name":"tophat_out/accepted_hits.bam","type":"RAFILE","id":"accepted_hits_bam"},{"subtype":"DUMMY","name":"tophat_out/unmapped.bam","type":"RAFILE","id":"unmapped_bam"},{"cmd":"bamcat I=__IN_BAM1__ I=__IN_BAM2__ level=0","type":"EXEC","id":"bamcat"},{"cmd":"tee __OUT1__","type":"EXEC","id":"tee_headerSQfix"},{"cmd":"samtools view -h -","type":"EXEC","id":"sam_headerSQfix"},{"comment":"careful to not send SIGPIPE back to tee, yet ensure EOF to reheader as soon as header processed","cmd":"perl -nle 'use strict; use autodie; our%sq; our$re; our$body; BEGIN{$body=0; $re=qr/^\\@SQ.*\\tSN:([^\\t]+)/; open(my$df,q(<),shift@ARGV); while(<$df>){chomp; if(/$re/){$sq{$1}=$_;} } close $df; } next if $body ; if(/$re/){$_=$sq{$1}||$_}elsif(/^[^@]/){open STDOUT,q(>),q(/dev/null); $body=1; next} print' __IN_DICT__","type":"EXEC","id":"alterSQ_headerSQfix","description":"where SN field in SQ header record matches one in the given dict file, replace that SQ record with that in the dict file"},{"cmd":"mbuffer -f -q -m 5M","type":"EXEC","id":"mbuffer_headerSQfix"},{"cmd":"samtools reheader __IN_SAMHEADER__ __IN_BAM__","type":"EXEC","id":"reheader_headerSQfix"},{"cmd":"bam12split verbose=0 level=0","type":"EXEC","id":"bam12split_tophat"},{"cmd":"bamsort SO=queryname level=0","type":"EXEC","id":"bamsort_qname"},{"comment":"bam12auxmerge <= 0.0.142 requires SQ headers removed. Alignment removal also required for bamadapterclip (at least 0.0.142)","cmd":"bamreset resetaux=0 level=0 verbose=0 __PREALN_BAM__","type":"EXEC","id":"bamreset_prealn"},{"cmd":"bamadapterclip verbose=0 level=0","type":"EXEC","id":"bamadapterclip_prealn"},{"cmd":"bam12auxmerge level=0 rankstrip=1 ranksplit=0 zztoname=0 clipreinsert=1 __PREALN_BAM__","type":"EXEC","id":"bam12auxmerge"},{"cmd":"/software/jdk1.7.0_25/bin/java -Xmx1000m -jar /nfs/users/nfs_d/dj3/repos/illumina2bam/dist/AlignmentFilter.jar IN=__PHIX_INBAM__ IN=__TARGET_INBAM__ OUT=__PHIX_OUTBAM__ OUT=/dev/stdout METRICS_FILE=__AF_METRICS__ VALIDATION_STRINGENCY=SILENT CREATE_MD5_FILE=false VERBOSITY=INFO QUIET=false COMPRESSION_LEVEL=5 MAX_RECORDS_IN_RAM=500000 CREATE_INDEX=false","type":"EXEC","id":"alignment_filter"},{"name":"af_metrics.log","type":"OUTFILE","id":"af_metrics"},{"cmd":"bamsort SO=coordinate level=0","type":"EXEC","id":"bamsort_coord_phix"},{"cmd":"bammarkduplicates M=markdups_metrics.txt level=0","type":"EXEC","id":"bammarkduplicates_phix"},{"cmd":"bamrecompress numthreads=2","type":"EXEC","id":"bamrecompress_phix"},{"name":"phix.bam","type":"OUTFILE","id":"phix_bam"},{"cmd":"bamsort SO=coordinate level=0","type":"EXEC","id":"bamsort_coord_target"},{"cmd":"bammarkduplicates M=markdups_metrics.txt level=0","type":"EXEC","id":"bammarkduplicates_target"},{"cmd":"bamrecompress numthreads=2","type":"EXEC","id":"bamrecompress_target"},{"name":"target.bam","type":"OUTFILE","id":"target_bam"},{"cmd":"bamcat verbose=0 level=0 __PHIXBAM__ __TARGETBAM__","type":"EXEC","id":"bamcat_output"},{"cmd":"bamseqchksum","type":"EXEC","id":"seqchksum_output"},{"cmd":"bamseqchksum","type":"EXEC","id":"seqchksum_input"},{"cmd":"cmp -s __INPUTCHK__ __OUTPUTCHK__","type":"EXEC","id":"cmp_seqchksum","description":"check input primary/sequence data matches output"}],"description":"Process RNASeq data in BAM files within NPG Pipeline producing WTSI DNAP Sequencing Informatics BAM output: full PG history, complete SQ lines, adapter marking, recoding indexing sequence etc"}