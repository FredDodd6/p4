{
"version":"1.0",
"description":"steps in the alignment pipeline to post-process bam files produced by the AlignmentFilter",
"subgraph_io":{
	"ports":{
		"inputs":{
			"_stdin_":"bamsort_coord",
			"reference_genome_fasta":"scramble:__REFERENCE_GENOME_FASTA__"
		},
		"outputs":{
			"_stdout_":"bamrecompress",
			"out_cram":"scramble_tee:__CRAM_OUT__",
			"out_cram_md5":"postprocess_md5",
			"out_bamcheck":"bamcheck",
			"out_stats_F0x900":"samtools_stats_F0x900",
			"out_stats_F0xB00":"samtools_stats_F0xB00",
			"out_flagstat":"flagstat"
		}
	}
},
"subst_params":[
        {
                "id": "basic_pipeline_params",
                "type":"SPFILE",
                "name": "alignment_common.spf",
                "required": "no",
                "comment":"this will expand to a set of subst_param elements"
        },
	{"name":"phix_or_target","required":"yes"},
	{
		"name":"bs_tmpfile_flag",
		"required":"no",
		"subst_constructor":{
			"vals":[
				"tmpfile=",
				{"subst":"outdatadir"},
				"/",
				{"subst":"bstmp"},
				"_",
				{"subst":"rpt"},
				{"subst":"phix_or_target"},
				".tmp"
			],
			"postproc":{"op":"concat", "pad":""}
		}
	},
	{
		"name":"bamsort_coord",
		"required":"yes",
		"subst_constructor":{
			"vals":[
				"bamsort",
				"SO=coordinate",
				"level=0",
				"verbose=0",
				"fixmate=1",
				"adddupmarksupport=1",
				{"subst":"bs_tmpfile_flag"}
			],
			"postproc":{"op":"pack", "pad":" "}
		}
	},
	{
		"name":"bmd_tmpfile_flag",
		"required":"no",
		"subst_constructor":{
			"vals":[
				"tmpfile=",
				{"subst":"outdatadir"},
				"/",
				{"subst":"bmdtmp","required":"yes"},
				"_",
				{"subst":"rpt"},
				{"subst":"phix_or_target"},
				".tmp"
			],
			"postproc":{"op":"concat", "pad":""}
		}
	},
	{
		"name":"bmd_metrics_file_flag",
		"required":"no",
		"subst_constructor":{
			"vals":[
				"M=",
				{"subst":"outdatadir"},
				"/",
				{"subst":"rpt"},
				{"subst":"phix_or_target"},
				".markdups_metrics.txt"
			],
			"postproc":{"op":"concat", "pad":""}
		}
	},
	{"name":"bmd_cmd","required":"no","default":"bamstreamingmarkduplicates"},
	{
		"name":"bammarkduplicates",
		"required":"yes",
		"subst_constructor":{
			"vals":[
				{"subst":"bmd_cmd"},
				" level=0",
				"verbose=0",
				{"subst":"bmd_tmpfile_flag"},
				{"subst":"bmd_metrics_file_flag"}
			],
			"postproc":{"op":"pack", "pad":" "}
		}
	},
	{"name":"stats_filter__F0x900","required":"no","default":"0x900"},
	{
		"name":"samtools_stats_F0x900",
		"required":"yes",
		"subst_constructor":{
			"vals":[
				{"subst":"samtools_executable"},
				"stats",
				"-F",
				{"subst":"stats_filter__F0x900"},
				"-"
			],
			"postproc":{"op":"pack","pad":" "}
		}
	},
	{"name":"stats_filter__F0xB00","required":"no","default":"0xB00"},
	{
		"name":"samtools_stats_F0xB00",
		"required":"yes",
		"subst_constructor":{
			"vals":[
				{"subst":"samtools_executable"},
				"stats",
				"-F",
				{"subst":"stats_filter__F0xB00"},
				"-"
			],
			"postproc":{"op":"pack","pad":" "}
		}
	},
	{"name":"calibration_pu_executable","required":"no","default":"calibration_pu"},
	{"name":"calibration_pu_bad_tiles_count","required":"no","default":"2"},
	{
		"name":"calibration_pu_prefix",
		"required":"yes",
		"subst_constructor":{
			"vals":[
				{"subst":"outdatadir"},
				"/",
				{"subst":"rpt"},
				{"subst":"phix_or_target"},
				{"subst":"bam_ext"}
			],
			"postproc":{"op":"concat", "pad":""}
		}
	},
	{
		"name":"calibration_pu_cmd",
		"required":"yes",
		"subst_constructor":{
			"vals":[
				{"subst":"calibration_pu_executable"},
				"-p",
				{"subst":"calibration_pu_prefix"},
				"-filter-bad-tiles",{"subst":"calibration_pu_bad_tiles_count"},
				"-"
			],
			"postproc":{"op":"pack","pad":" "}
		}
	},
	{
		"name":"br_indexfile_flag",
		"required":"no",
		"subst_constructor":{
			"vals":[
				"indexfilename=",
				{"subst":"outdatadir"},
				"/",
				{"subst":"rpt"},
				{"subst":"phix_or_target"},
				".bai"
			],
			"postproc":{"op":"concat", "pad":""}
		}
	},
	{
		"name":"br_md5file_flag",
		"required":"no",
		"subst_constructor":{
			"vals":[
				"md5filename=",
				{"subst":"outdatadir"},
				"/",
				{"subst":"rpt"},
				{"subst":"phix_or_target"},
				".bam.md5"
			],
			"postproc":{"op":"concat", "pad":""}
		}
	},
	{
		"name":"br_numthreads_flag",
		"required":"no",
		"subst_constructor":{
			"vals":[
				"numthreads=",
				{"subst":"br_numthreads_val"}
			],
			"postproc":{"op":"concat", "pad":""}
		}
	},
	{
		"name":"br_tmpfile_flag",
		"required":"no",
		"subst_constructor":{
			"vals":[
				"tmpfile=",
				{"subst":"outdatadir"},
				"/",
				{"subst":"brtmp"},
				"_",
				{"subst":"rpt"},
				{"subst":"phix_or_target"},
				".tmp"
			],
			"postproc":{"op":"concat", "pad":""}
		}
	},
	{
		"name":"bamrecompress",
		"required":"yes",
		"subst_constructor":{
			"vals":[
				"bamrecompress",
				"verbose=0",
				"index=1",
				{"subst":"br_indexfile_flag"},
				"md5=1",
				{"subst":"br_md5file_flag"},
				{"subst":"br_numthreads_flag"},
				{"subst":"br_tmpfile_flag"}
			],
			"postproc":{"op":"pack", "pad":" "}
		}
	},
	{"name":"flagstats_filter_flag","required":"no","default":"0x900"},
	{
		"name":"samtools_flagstat_filter",
		"required":"yes",
		"subst_constructor":{
			"vals":[
				{"subst":"samtools_executable"},
				"view",
				"-u",
				"-F",
				{"subst":"flagstats_filter_flag"},
				"-"
			],
			"postproc":{"op":"pack","pad":" "}
		}
	},
	{
		"name":"samtools_flagstat_cmd",
		"required":"yes",
		"subst_constructor":{
			"vals":[
				{"subst":"samtools_executable"},
				"flagstat",
				"-"
			],
			"postproc":{"op":"pack","pad":" "}
		}
	}
],
"nodes":[
	{
		"id":"bamsort_coord",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":{"subst":"bamsort_coord"}
	},
	{
		"id":"bammarkduplicates",
		"comment":"default tool bamstreamingmarkduplicates must be from Biobambam >= 0.0.174",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":{"subst":"bammarkduplicates"}
	},
	{
		"id":"bmd_multiway",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": false,
		"cmd":["teepot", "-w", "300", "__SCRAMBLE_OUT__", "__BAMCHECK_OUT__", "__FLAGSTAT_OUT__", "__CALIBRATION_PU_OUT__", "__BAM_OUT__", "__SAMTOOLS_STATS_F0x900__", "__SAMTOOLS_STATS_F0xB00__"]
	},
	{
		"id":"scramble",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":["scramble", "-I", "bam", "-O", "cram", "-r", "__REFERENCE_GENOME_FASTA__"]
	},
	{
		"id":"scramble_tee",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": false,
		"cmd":["teepot", "-w", "30000", "__CRAM_OUT__", "__MD5_OUT__"],
		"comment":"allow a generous 500 minutes for the teepot timeout"
	},
	{
		"id":"scramble_md5",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":"md5sum"
	},
	{
		"id":"postprocess_md5",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":["tr", "-d", " \\-\n"],
		"comment":"the double-backslash is required to get the correct character set to the tr command"
	},
	{
		"id":"bamcheck",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":["bamcheck", "-F", "0x900"]
	},
	{
		"id":"samtools_stats_F0x900",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":{"subst":"samtools_stats_F0x900"}
	},
	{
		"id":"samtools_stats_F0xB00",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":{"subst":"samtools_stats_F0xB00"}
	},

	{
		"id":"calibration_pu",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": false,
		"cmd":{"subst":"calibration_pu_cmd"}
	},
	{
		"id":"bamrecompress",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":{"subst":"bamrecompress"}
	},
	{
		"id":"flagstat_filter",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":{"subst":"samtools_flagstat_filter"},
		"description":"Filter out secondary and supplementary alignment records"
	},
	{
		"id":"flagstat",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":{"subst":"samtools_flagstat_cmd"}
	}
],
"edges":[
	{ "id":"bamsort_to_bammarkduplicates", "from":"bamsort_coord", "to":"bammarkduplicates" },
	{ "id":"bammarkduplicates_to_multiway", "from":"bammarkduplicates", "to":"bmd_multiway" },
	{ "id":"bmdmw_to_scramble", "from":"bmd_multiway:__SCRAMBLE_OUT__", "to":"scramble"
	}, { "id":"scramble_to_scramble_tee", "from":"scramble", "to":"scramble_tee" },
	{ "id":"scramble_tee_to_md5", "from":"scramble_tee:__MD5_OUT__", "to":"scramble_md5" },
	{ "id":"md5_to_postprocess", "from":"scramble_md5", "to":"postprocess_md5" },
	{ "id":"bmd_to_bamcheck", "from":"bmd_multiway:__BAMCHECK_OUT__", "to":"bamcheck" },
	{ "id":"bmd_to_sts_F0x900", "from":"bmd_multiway:__SAMTOOLS_STATS_F0x900__", "to":"samtools_stats_F0x900" },
	{ "id":"bmd_to_sts_F0xB00", "from":"bmd_multiway:__SAMTOOLS_STATS_F0xB00__", "to":"samtools_stats_F0xB00" },
	{ "id":"bmd_to_calibration_pu", "from":"bmd_multiway:__CALIBRATION_PU_OUT__", "to":"calibration_pu" },
	{ "id":"bmd_to_bam", "from":"bmd_multiway:__BAM_OUT__", "to":"bamrecompress" },
	{ "id":"bmd_to_flagstat", "from":"bmd_multiway:__FLAGSTAT_OUT__", "to":"flagstat_filter" },
	{ "id":"flagstat_filter_to_flagstat", "from":"flagstat_filter", "to":"flagstat" }
]
}
